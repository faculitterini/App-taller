{% extends "base.html" %}
{% block contenido %}

<h3>Detalle de reparación</h3>

<p>
    <strong>Cliente:</strong> {{ cliente[1] }} {{ cliente[2] }} <br>
    <strong>Vehículo:</strong> {{ vehiculo[2] }} - {{ vehiculo[3] }} {{ vehiculo[4] }} <br>
    <strong>Fecha:</strong> {{ reparacion[2] }} <br>
</p>

<p>
    <strong>Descripción:</strong><br>
    {{ reparacion[3] }}
</p>

{% if reparacion[4] %}
<p>
    <strong>Notas internas:</strong><br>
    {{ reparacion[4] }}
</p>
{% endif %}

<hr>

<h4>Ítems de la reparación</h4>

<a href="/reparaciones/{{ reparacion[0] }}/items/nuevo" class="btn btn-success mb-3">
    + Agregar ítem
</a>

<hr class="my-4">

<div class="d-flex justify-content-between align-items-center mb-2">
    <h5 class="mb-0">Imágenes de la reparación</h5>
    <a href="{{ url_for('reparacion_imagen_nueva', reparacion_id=reparacion[0]) }}" class="btn btn-sm btn-outline-primary">
        + Agregar imagen
    </a>
</div>

{% if imagenes %}
    <div class="row">
        {% for img in imagenes %}
            <div class="col-md-3 col-sm-4 col-6 mb-3">
                <div class="card">
                    <a href="{{ url_for('static', filename='uploads/' ~ img[1]) }}" target="_blank">
                        <img src="{{ url_for('static', filename='uploads/' ~ img[1]) }}"
                             class="card-img-top"
                             style="max-height: 160px; object-fit: cover;">
                    </a>
                    <div class="card-body p-2">
                        {% if img[2] %}
                            <p class="card-text small mb-1">{{ img[2] }}</p>
                        {% endif %}
                        <a href="{{ url_for('reparacion_imagen_eliminar', img_id=img[0]) }}"
                           class="btn btn-sm btn-outline-danger w-100"
                           onclick="return confirm('¿Eliminar esta imagen?');">
                            Eliminar
                        </a>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
{% else %}
    <p class="text-muted">No hay imágenes cargadas para esta reparación.</p>
{% endif %}

<table class="table table-striped align-middle">
    <tr>
        <th>Concepto</th>
        <th>Cant.</th>
        <th>Precio unit.</th>
        <th>Desc. %</th>
        <th>Subtotal</th>
        <th></th>
    </tr>

    {% for it in items %}
        {% set cantidad = it[3] or 0 %}
        {% set precio = it[4] or 0 %}
        {% set desc = it[5] or 0 %}
        {% set subtotal = cantidad * precio * (1 - desc/100) %}

        <tr>
            <!-- CONCEPTO EN MAYÚSCULAS -->
            <td>{{ (it[2] or '')|upper }}</td>

            <!-- Cantidad: si es entera NO mostrar .0 -->
            <td>
                {% if cantidad == cantidad|int %}
                    {{ cantidad|int }}
                {% else %}
                    {{ "%.2f"|format(cantidad) }}
                {% endif %}
            </td>

            <!-- Precio unitario -->
            <td>{{ "%.2f"|format(precio) }}</td>

            <!-- Descuento -->
            <td>{{ desc }}</td>

            <!-- Subtotal -->
            <td>{{ "%.2f"|format(subtotal) }}</td>

            <td>
                <a href="/items/editar/{{ it[0] }}" class="btn btn-sm btn-primary">Editar</a>
                <a href="/items/eliminar/{{ it[0] }}" class="btn btn-sm btn-danger">Eliminar</a>
            </td>
        </tr>
    {% endfor %}
</table>

<h4 class="mt-3">Total: $ {{ "%.2f"|format(total) }}</h4>

<!-- Botón presupuesto -->
<a href="/reparaciones/{{ reparacion[0] }}/factura" class="btn btn-outline-primary mt-3">
    Ver / Generar presupuesto
</a>

<!-- Botón volver -->
<a href="/vehiculos/{{ vehiculo[0] }}/reparaciones" class="btn btn-outline-secondary mt-3">
    ← Volver a reparaciones
</a>

{% endblock %}
